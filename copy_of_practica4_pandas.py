# -*- coding: utf-8 -*-
"""Copy of Practica4_Pandas.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1iFls-0A-Ui-05iYaLrjfa8IJv-tUshrP

<a href="https://colab.research.google.com/github/DCDPUAEM/DCDP/blob/main/01%20Programaci%C3%B3n%20en%20Python/notebooks/exercises/Practica4_Pandas.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a>
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

"""### __Data set de vinos del mundo__

Esta es una versi√≥n reducida de la base de datos [winemag-data](https://gist.github.com/clairehq/79acab35be50eaf1c383948ed3fd1129), que contiene una rese√±a en ingl√©s sobre una gran cantidad de vinos del mundo.

### __Descripci√≥n de los campos__

 - **country**: El pa√≠s de donde proviene el vino
 - **description** : Algunas frases de un sommelier que describen el sabor, olor, apariencia, sensaci√≥n, etc. del vino.
 - **designation**: La denominaci√≥n. El vi√±edo dentro de la bodega de donde proceden las uvas que elaboraron el vino.
 - **points**: la cantidad de puntos que WineEnthusiast calific√≥ al vino en una escala del 1 al 100 (aunque dicen que solo publican rese√±as de vinos con una puntuaci√≥n> = 80).
 - **price**: El costo de una botella de vino.
 - **province**: La provincia o estado de donde proviene el vino
 - **region_1**: el √°rea de cultivo de vino en una provincia o estado (es decir, Napa)
 - **region_2**: a veces hay regiones m√°s espec√≠ficas, especificadas dentro de un √°rea de cultivo del vino (es decir, Rutherford dentro del Valle de Napa), pero este valor a veces puede estar en blanco.
 - **taster_name**: nombre de la persona que prob√≥ y revis√≥ el vino.
 - **taster_twitter_handle**: identificador de Twitter para la persona que prob√≥ y revis√≥ el vino.
 - **title**: el t√≠tulo de la rese√±a de vinos, que a menudo contiene la cosecha si est√° interesado en extraer esa caracter√≠stica.
 - **variety**: la variedad: el tipo de uva utilizada para elaborar el vino (es decir, Pinot Noir).
 - **winery**: la bodega que hizo el vino.

### TEST
"""

# Fetch the dataset using the raw GitHub URL.
!curl --remote-name \
     -H 'Accept: application/vnd.github.v3.raw' \
     --location https://raw.githubusercontent.com/DCDPUAEM/DCDP/main/01%20Programaci%C3%B3n%20en%20Python/data/winemag-data-less.csv

# leemos el dataframe usando read_csv
df = pd.read_csv("winemag-data-less.csv")
print(df.info())
df.head(3)

#Tiremos la columna Unnamed
df.drop('Unnamed: 0',axis=1,inplace=True)
df.head(3)

"""### __Veamos cuantas rese√±as de vinos mexicanos tenemos.__

#### &#9758; Construye una nueva Tabla con las rese√±as de vinos mexicanos.
- Qu√©date **s√≥lo** con las siguientes columnas: `['country','winery','variety','description','points','price']`
- Haz que el √≠ndice se reinicie en 0.
- Guarda este DataFrame en la variable vinosMX.
"""

vinosMX = df[df['country']=='Mexico'][['country','winery','variety','description','points','price']].reset_index(drop=True)

"""
SECUENCIA:
1. Ubicar todos los registros de M√©xico usando indexaci√≥n booleana
2. De este DataFrame resultante, extraer solamente las columnas solicitadas.
3. Reiniciar el √≠ndice usando reset_index()
4. Tirar (drop) la nueva columna index
5. Asignar el resultado de este proceso a la variable vinosMX
"""
# TU CODIGO
# 1. Ubicar todos los registros de M√©xico usando indexaci√≥n booleana
vinosMX = df[df['country']=='Mexico']

# 2. De este DataFrame resultante, extraer solamente las columnas solicitadas.
vinosMX = vinosMX[['country','winery','variety','description','points','price']]

# 3. Reiniciar el √≠ndice usando reset_index()
vinosMX = vinosMX.reset_index()

# 4. Tirar (drop) la nueva columna index
vinosMX = vinosMX.drop('index',axis=1)
vinosMX

"""### __Veamos cuantas rese√±as de vinos por pa√≠s tenemos.__

#### &#9758; Muestra en una gr√°fica de barras la distribuci√≥n del n√∫mero de rese√±as por pa√≠s (_top 10_).

#### Puedes auxiliarte con alguna de estos m√©todos de Pandas:
 - [pandas.DataFrame.count](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.count.html)
 - [pandas.Series.value_counts](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.value_counts.html)
 - [pandas.Series.index](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.index.html)
 - [pandas.Series.values](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.values.html)
"""

"""
SECUENCIA:
1. Ubicar el nombre de la columna de pa√≠s
2. Sobre esta columna, obtener la Serie correspondiente
3. Hacer un conteo de los valores √∫nicos sobre esta Serie

4. X en la gr√°fica de barras son los pa√≠ses (√≠ndice de la Serie)
5. Y en la gr√°fica de barras son los conteos por pa√≠s (values de la Serie)
6. Usar Seaborn para graficar el diagrama de barras
7. Rotular la gr√°fica y los ejes
"""
# 1. Ubicar el nombre de la columna de pa√≠s
# 2. Sobre esta columna, obtener la Serie correspondiente
# 3. Hacer un conteo de los valores √∫nicos sobre esta Serie
conteos=df.country.value_counts()

# 4. X en la gr√°fica de barras son los pa√≠ses (√≠ndice de la Serie)
# 5. Y en la gr√°fica de barras son los conteos por pa√≠s (values de la Serie)


plt.figure(figsize=(16,7))
sns.barplot(conteos[:10])

# En una sola l√≠nea:
#sns.barplot(df.country.value_counts().index[:10], df.country.value_counts().values[:10])

plt.xlabel("Pa√≠ses")
plt.ylabel("N√∫mero de vinos")
plt.title("Rese√±as por pa√≠s (Top 10)")

plt.show()

"""### __Veamos ahora cu√°l es el precio promedio por cada pa√≠s.__

#### &#9758; Muestra en una gr√°fica de barras el precio promedio por pa√≠s, en orden descendente (_top 10_).

Puedes consultar:
 - [pandas.DataFrame.groupby](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.groupby.html)

#### &#9758; ¬øCu√°l ser√≠a el precio promedio por variedad?

üôÇ __Escribe la secuencia de pasos que tendr√≠as que realizar.__
"""

"""
SECUENCIA:

"""
# 1. Agrupar el DataFrame por la columna variedad
promedios = df.groupby('variety').price.mean()

# 2. Ordenar los precios promedios en orden descendente
promedios = promedios.sort_values(ascending=False)

# 3. Extraer los 10 primeros
promedios = promedios[:10]

# 4. X en la gr√°fica de barras son las variedades (√≠ndice de la Serie)
# 5. Y en la gr√°fica de barras son los precios promedios (values de la Serie)

plt.figure(figsize=(16,7))
sns.barplot(x=promedios.index, y=promedios.values)

plt.xlabel("Pa√≠s")
plt.ylabel("Precio promedio (D√≥lares)")
plt.title("Precio promedio (Top 10)")

plt.show()

"""#### Agregando anotaciones a nuestros gr√°ficos

Es posible agregar informaci√≥n a nuestros gr√°ficos, en forma de texto, o dibujos (e.g. flechas, l√≠neas, c√≠rculos, etc.). Para ello, se utiliza la anotaci√≥n (annotate) de ejes (axes). Detallar aqu√≠ c√≥mo funciona nos llevar√≠a mucho tiempo. Puedes consultar la documentaci√≥n en estas ligas:

- [matplotlib.Artist](https://matplotlib.org/3.3.3/api/artist_api.html#matplotlib.artist.Artist)
    - [Artist tutorial](https://matplotlib.org/3.3.3/tutorials/intermediate/artists.html)
- [matplotlib.axes](https://matplotlib.org/3.3.3/api/axes_api.html#matplotlib.axes.Axes)
- [matplotlib.patches.Patch](https://matplotlib.org/3.3.3/api/axes_api.html#matplotlib.axes.Axes)
- [matplotlib.patches.Rectangle](https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.patches.Rectangle.html)
- [matplotlib.pyplot.annotate](https://matplotlib.org/3.3.3/api/_as_gen/matplotlib.pyplot.annotate.html)
"""

#Definimos el tama√±o del canvas
plt.figure(figsize=(16,7))

# la variable "ax" (axes) contiene la informaci√≥n  del gr√°fico de barras.
# En particular, contiene todo lo relativo a los parches (rect√°ngulos) del barplot.
sns.barplot(x=promedios.index, y=promedios.values)
ax = plt.gca()
# Recorremos cada rect√°ngulo
for p in ax.patches:
    ax.annotate("%.2f" % p.get_height(),\
                (p.get_x() + p.get_width() / 2., p.get_height()),\
                ha='center', va='center', fontsize=11, color='gray',\
                xytext=(0, 10),\
                textcoords='offset points')

plt.show()

"""### __Ahora queremos darnos una idea de cu√°les podr√≠an ser los pa√≠ses cuyos vinos tienen una mejor raz√≥n calidad-precio en promedio.__

#### &#9758; Muestra en una gr√°fica de barras la raz√≥n puntos/precio promedio por pa√≠s, en orden descendente (_top 10_). Muestra los valores de la raz√≥n sobre cada barra.

‚úã __Recuerda que si divides entre 0 o Nan obtendr√°s inf o nan__

üôÇ __Escribe la secuencia de pasos que tendr√≠as que realizar.__
"""

plt.figure(figsize=(8,4))
sns.boxplot(x=df.points)
plt.title("Boxplot del puntaje (calidad)")
plt.show()

import matplotlib.pyplot as plt
import seaborn as sns

plt.figure(figsize=(10, 5))

# 1. Calcular la raz√≥n puntos/precio por pa√≠s
promedios = df.groupby('country').apply(lambda x: x['points'].mean() / x['price'].mean())

# **Comentario:** Esta l√≠nea calcula la raz√≥n puntos/precio para cada pa√≠s
# utilizando la funci√≥n `groupby()` de Pandas y la funci√≥n `lambda`.

# 2. Ordenar los resultados en orden descendente seg√∫n la raz√≥n puntos/precio
promedios = promedios.sort_values(ascending=False)

# **Comentario:** Esta l√≠nea ordena los resultados de la raz√≥n puntos/precio
# en orden descendente.

# 3. Seleccionar los 10 primeros pa√≠ses
top_10_paises = promedios.head(10)

# **Comentario:** Esta l√≠nea selecciona los 10 pa√≠ses con la mejor
# raz√≥n puntos/precio.

# 4. Graficar los resultados en una gr√°fica de barras
ax = sns.barplot(x=top_10_paises.index, y=top_10_paises.values)

# **Comentario:** Esta l√≠nea crea una gr√°fica de barras
# con los 10 pa√≠ses seleccionados.

# Agregar t√≠tulo a la gr√°fica
plt.title("Mejor raz√≥n puntos/precio por pa√≠s (Top 10)")

# Rotar las etiquetas del eje X
plt.xticks(rotation=45, ha="right")

# Etiquetas de los ejes
plt.xlabel("Pa√≠s")
plt.ylabel("Raz√≥n Puntos/Precio")
for p in ax.patches:
    ax.annotate("%.2f" % p.get_height(), (p.get_x() + p.get_width() / 2., p.get_height()),
                 ha='center', va='center', fontsize=11, color='gray', xytext=(0, 10),
                 textcoords='offset points')

# Mostrar la gr√°fica
plt.show()

"""### __¬øQu√© vinos tienen la mejor puntuaci√≥n y a qu√© pa√≠ses pertenecen?__

#### &#9758; Muestra en una gr√°fica de pastel la proporci√≥n de los pa√≠ses que tienen los 20 mejores vinos; es decir, los primeros 20 de mayor puntaje.  
"""

#TU CODIGO
# Filtrar los 20 mejores vinos
mejores_vinos = df.sort_values('points', ascending=False).head(20)

# Agrupar por pa√≠s y contar el n√∫mero de vinos
paises_mejores_vinos = mejores_vinos.groupby('country').size()

# Calcular la proporci√≥n de vinos por pa√≠s
proporcion_paises = paises_mejores_vinos / 20

# Crear la gr√°fica de pastel
plt.figure(figsize=(8, 8))
plt.pie(proporcion_paises, labels=paises_mejores_vinos.index, autopct='%1.1f%%')
plt.title('Proporci√≥n de pa√≠ses con los 20 mejores vinos')
plt.show()

"""### __¬øCu√°les son las 10 variedades de uva m√°s abundantes y en qu√© proporci√≥n?__

#### &#9758; Da una soluci√≥n utilizando s√≥lo dos l√≠neas de c√≥digo
"""

#TU CODIGO
variedades = df['variety'].value_counts().head(10)
variedades

"""### __¬øCu√°les son las 20 bodegas m√°s mencionadas y en qu√© proporci√≥n?__

#### &#9758; Da una soluci√≥n utilizando s√≥lo dos l√≠neas de c√≥digo
"""

#TU CODIGO
bodegas = df['winery'].value_counts().head(10)
bodegas

"""### __Vamos ahora a construir una nueva tabla de informaci√≥n__

#### &#9758; Construye una tabla que muestre pa√≠s, variedad de uva, bodega, y valores de puntuaci√≥n y precio.
- Considera las 10 variedades de uva y las 20 bodegas m√°s importantes.
- Haz una tabla con estos datos y s√≥lo los valores de pa√≠s, bodega, variedad, puntuaci√≥n y precio correspondientes.
- Agrega una columna con el valor de puntos/precio
- Cambia el nombre de la bodega para que √©ste incluya su pa√≠s de origen.
- Ordena los datos por nombre de pa√≠s, variedad y bodega (orden ascendente).
"""

# Filtrar las 10 variedades m√°s abundantes
variedades_abundantes = df.groupby('variety').size().sort_values(ascending=False).head(10).index

# Filtrar las 20 bodegas m√°s importantes
bodegas_importantes = df.groupby('winery').size().sort_values(ascending=False).head(20).index

# Seleccionar las filas que cumplen con las condiciones
tabla_filtrada = df[(df['variety'].isin(variedades_abundantes)) & (df['winery'].isin(bodegas_importantes))]

# Agregar columna con valor puntos/precio
tabla_filtrada['puntos_precio'] = tabla_filtrada['points'] / tabla_filtrada['price']

# Cambiar nombre de la bodega para incluir pa√≠s de origen
tabla_filtrada['winery'] = tabla_filtrada['winery'] + ' (' + tabla_filtrada['country'] + ')'

# Ordenar por pa√≠s, variedad y bodega
p_v = tabla_filtrada.sort_values(by=['country', 'variety', 'winery'])

"""#### &#9758; Observa la relaci√≥n puntos-precio por pa√≠s"""

sns.relplot(x="points", y="price", hue="country", col='country',kind="line", data=p_v)

"""#### &#9758; Observa las distribuciones por pares en funci√≥n de la variedad de uva."""

sns.pairplot(p_v, hue="variety",height=3,palette='rocket')

"""#### &#9758; Observa las distribuciones por pares en funci√≥n del pa√≠s."""

#TU CODIGO
sns.pairplot(p_v, hue='country')
plt.show()

"""#### &#9758; Observa las distribuciones por pares en funci√≥n de la bodega."""

#TU CODIGO
sns.pairplot(p_v, hue='winery')
plt.show()

"""#### &#9758; Observa las distribuciones (scatter) de precio por variedad de uva."""

#Diagrama de relaciones
sns.relplot(x='variety', y='price', data=p_v, kind='scatter', alpha=0.7)

#t√≠tulo y etiquetas
plt.xlabel('Variedad de Uva')
plt.ylabel('Precio')
plt.title('Distribuci√≥n de Precio por Variedad de Uva')

# Rotar las etiquetas del eje X
plt.xticks(rotation=45, ha='right')

# Ajustar el dise√±o
plt.tight_layout()

# Mostrar la gr√°fica
plt.show()

"""#### &#9758; Observa las distribuciones (scatter) de precio por bodega."""

sns.relplot(x='winery', y='price', data=p_v, kind='scatter', alpha=0.7)

plt.xlabel('Bodega')
plt.ylabel('Precio')
plt.title('Distribuci√≥n de Precio por Bodega')


plt.tight_layout()
plt.xticks(rotation=45, ha='right')

plt.show()

"""#### &#9758; Observa las distribuciones (scatter) de puntos/precio por bodega."""

sns.relplot(x='winery', y='puntos_precio', data=p_v, kind='scatter', alpha=0.7)


plt.xlabel('Bodega')
plt.ylabel('Puntos/Precio')
plt.title('Distribuci√≥n de Puntos/Precio por Bodega')


plt.tight_layout()
plt.xticks(rotation=45, ha='right')

plt.show()

"""#### &#9758; Observa las distribuciones (scatter) de puntos/precio por pa√≠s."""

sns.relplot(x='country', y='puntos_precio', data=p_v, kind='scatter', alpha=0.7)


plt.xlabel('Pa√≠s')
plt.ylabel('Puntos/Precio')
plt.title('Distribuci√≥n de Puntos/Precio por Pa√≠s')


plt.tight_layout()
plt.xticks(rotation=45, ha='right')

plt.show()

"""### __Agrega los datos de M√©xico a esta √∫ltima tabla de informaci√≥n__

#### &#9758; Une la tabla de vinosMX a la tabla p_v
- Aseg√∫rate de __no agregar__ la columna de descripci√≥n
"""

from pandas import merge

vinosMX = vinosMX.rename(columns={'bodega': 'winery'})

# Si la columna 'description' existe en vinosMX, eliminarla
if 'description' in vinosMX.columns:
    vinosMX = vinosMX.drop(columns=['description'])

# Unir las tablas utilizando la columna 'country' como clave de uni√≥n
df3 = merge(p_v, vinosMX, on='country', how='outer')

# Mostrar la tabla completa
print(df3)

"""#### &#9758; Calcula los valores de points/price para los vinos de M√©xico
- TIP: Usa el m√©todo apply sobre `df3[['points','price','points/price']]`
"""

# Filtrar la tabla para vinos de M√©xico
df_mx = df3[df3['country'] == 'Mexico']

# Calcular la columna puntos_precio
df_mx['puntos_precio'] = df_mx['points_y'] / df_mx['price_y']

# Mostrar la tabla con los valores de puntos_precio para vinos de M√©xico
print(df_mx)

"""#### &#9758; Observa la relaci√≥n puntos-precio por pa√≠s"""

sns.relplot(x="points_x", y="price_x", hue="country", col='country',kind="line", data=df3)

"""#### &#9758; Observa las distribuciones por pares en funci√≥n del pa√≠s.
- Construye una tabla auxiliar "mx_top", donde los datos de M√©xico (en df3) aparezcan al final de la tabla mx_top.
"""

# Separar los datos de M√©xico del resto de los pa√≠ses
mx_data = df3[df3['country'] == 'Mexico']
non_mx_data = df3[df3['country'] != 'Mexico']

# Concatenar los datos no mexicanos con los datos de M√©xico al final
mx_top = pd.concat([non_mx_data, mx_data])

# Visualizar las distribuciones por pares en funci√≥n del pa√≠s
sns.pairplot(mx_top, hue="country", height=3, palette='bright')
plt.show()

"""#### &#9758; Observa las distribuciones (scatter) de precios por bodega."""

plt.figure(figsize=(10, 6))
sns.scatterplot(data=mx_top, x='winery_x', y='price_x', alpha=0.7)
plt.xlabel('Bodega')
plt.ylabel('Precio')
plt.title('Distribuci√≥n de Precios por Bodega')
plt.xticks(rotation=90)
plt.tight_layout()
plt.show()

"""#### &#9758; Observa las distribuciones (scatter) de puntos/precio por bodega.
- Dibuja una l√≠nea que marque el promedio de todos los datos
- Dibuja marcas ubicadando los valores promedio por cada bodega (TIP: usa `groupby` sobre pa√≠s y bodega para calcular primero los valores promedio)
"""

mx_top.head()

import seaborn as sns
import matplotlib.pyplot as plt

# Calcular los valores promedio por cada bodega
medias = mx_top.groupby(['country', 'winery_x'])['puntos_precio'].mean().reset_index()

# Calcular el promedio de todos los datos
promedio_general = mx_top['puntos_precio'].mean()

# Crear el gr√°fico de dispersi√≥n de puntos/precio por bodega
plt.figure(figsize=(12, 6))
sns.scatterplot(data=mx_top, x='winery_x', y='puntos_precio', alpha=0.7)

# Dibujar una l√≠nea que marque el promedio de todos los datos
plt.axhline(y=promedio_general, color='r', linestyle='--', label='Promedio general')

# Dibujar marcas ubicando los valores promedio por cada bodega
for i in range(len(medias)):
    plt.text(i, medias.iloc[i]['puntos_precio'], f"{medias.iloc[i]['puntos_precio']:.2f}", ha='center', va='bottom', fontsize=8, color='blue')

plt.xlabel('Bodega')
plt.ylabel('Puntos/Precio')
plt.title('Distribuci√≥n de Puntos/Precio por Bodega')
plt.xticks(rotation=90)
plt.legend()
plt.tight_layout()
plt.show()

"""#### &#9758; Si consideramos la proporci√≥n de los pa√≠ses con mejor relaci√≥n puntos/precio, ¬øc√≥mo queda M√©xico?
- Usa un gr√°fico de pastel
"""

# TU CODIGO
# Calcular el promedio general de puntos/precio
promedio_general = mx_top['puntos_precio'].mean()

# Contar cu√°ntos vinos de cada pa√≠s est√°n por encima del promedio general
mejores_vinos_por_pais = mx_top[mx_top['puntos_precio'] > promedio_general].groupby('country')['country'].value_counts()


# Crear un gr√°fico de pastel para mostrar la proporci√≥n de pa√≠ses con mejores vinos
plt.figure(figsize=(8, 8))
plt.pie(mejores_vinos_por_pais, labels=mejores_vinos_por_pais.index, autopct='%1.1f%%', startangle=140)
plt.title('Proporci√≥n de pa√≠ses con mejores vinos (puntos/precio)')
plt.axis('equal')  # Equal aspect ratio ensures that pie is drawn as a circle.
plt.show()

# Calcular el promedio general de puntos/precio
promedio_general = mx_top['puntos_precio'].mean()

# Contar cu√°ntos vinos de M√©xico est√°n por encima del promedio general
proporcion_mexico = mx_top[(mx_top['country'] == 'Mexico') & (mx_top['puntos_precio'] > promedio_general)].shape[0] / mx_top[mx_top['country'] == 'Mexico'].shape[0]


# Calcular la proporci√≥n de vinos de M√©xico con una relaci√≥n puntos/precio por encima del promedio general
proporcion_mexico = len(mx_top[mejores_vinos_mexico]) / len(mx_top)

# Crear un gr√°fico de pastel para mostrar la proporci√≥n de vinos de M√©xico con mejor relaci√≥n puntos/precio
plt.figure(figsize=(8, 8))
plt.pie([proporcion_mexico, 1 - proporcion_mexico], labels=['M√©xico', 'Otros pa√≠ses'], autopct='%1.1f%%', startangle=140)
plt.title('Proporci√≥n de vinos de M√©xico con mejor relaci√≥n puntos/precio')
plt.axis('equal')  # Equal aspect ratio ensures that pie is drawn as a circle.
plt.show()

